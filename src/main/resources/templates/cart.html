<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Loại bỏ màu xanh và gạch chân mặc định của thẻ <a> */
a {
    text-decoration: none;
    color: inherit; /* Duy trì màu sắc của văn bản cha */
}

/* Tùy chỉnh hiệu ứng hover */
a:hover {
    text-decoration: none; /* Loại bỏ gạch chân khi hover */
    color: inherit; /* Giữ nguyên màu chữ khi hover */
}

/* Hiệu ứng zoom khi rê chuột vào sản phẩm */
.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* Thêm hiệu ứng đổi màu nền khi rê chuột vào sản phẩm */
.card:hover .card-body {
    background-color: #f8f9fa;
}

/* Cursor pointer khi rê chuột vào sản phẩm */
.card:hover {
    cursor: pointer;
}

    </style>
</head>
<body>

    <!-- Header -->
    <div th:replace="fragments/header :: header"></div>

    <!-- Giỏ hàng -->
    <div class="container mt-5">
        <h2>Giỏ hàng của bạn</h2>

        <div th:if="${cart != null}">
        	<!-- <form id="cartForm" action="/order/create" method="POST"> -->
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Chọn</th>
                        <th>Ảnh sản phẩm</th>
                        <th>Mô tả</th>
                        <th>Giá</th>
                        <th>Số lượng</th>
                        <th>Tổng</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${cart.cartItems}">
                        <td>
						    <!-- Checkbox chọn sản phẩm -->
						    <input type="checkbox" class="product-checkbox" 
						           th:value="${item.id}"  
						           th:data-price="${item.product.price}" 
						           th:data-quantity="${item.quantity}">
						</td>

                        <td>
                                <img th:src="@{${item.product.imageUrl}}" alt="product image" class="img-thumbnail" style="width: 100px;">
                            </td>
                            <td th:text="${item.product.description}">Mô tả sản phẩm</td>
                            <td th:text="${item.product.price}">Giá</td>
                            <td>
                                <button type="button" class="btn btn-outline-secondary" 
                                    th:onclick="|window.location='@{/cart/decreaseQuantity?(cartItemId=${item.id})}'|">-</button>
                                <input type="number" name="quantity" th:value="${item.quantity}" min="1" style="width: 60px;" readonly>
                                <button type="button" class="btn btn-outline-secondary" 
                                    th:onclick="|window.location='@{/cart/increaseQuantity?(cartItemId=${item.id})}'|">+</button>

                            </td>
                            <td th:text="${item.product.price * item.quantity}">Tổng</td>
                            <td>
                                <button type="button" class="btn btn-danger" th:onclick="|deleteItem(${item.id})|">Xóa</button>
                            </td>
                    </tr>
                </tbody>
            </table>

            <!-- Hiển thị tổng tiền -->
            	<h4>Total Price: <span id="total-price">0 VND</span></h4>
            	
            	<!-- Nút mua hàng -->
            <button id="buyButton" class="btn btn-primary">Đặt hàng</button>
            
        </div>
    </div>
    <!-- Các sản phẩm -->
  <div class="container mt-5">
    <h3>Có thể bạn cũng thích</h3>
    <div class="row">
        <div class="col-md-4" th:each="product : ${bestSellingProducts}">
            <!-- Thay đổi div thành a để tạo liên kết -->
            <a th:href="@{/product?productId={id}(id=${product.id})}" class="card">
                <img th:src="@{${product.imageUrl}}" class="card-img-top" alt="product image">
                <div class="card-body">
                    <h5 class="card-title" th:text="${product.name}">Tên sản phẩm</h5>
                    <p class="card-text" th:text="${product.description}">Mô tả sản phẩm</p>
                    <p class="card-text">
                        <strong>Giá: </strong><span th:text="${product.price}">Giá sản phẩm</span>
                    </p>
                </div>
            </a>
        </div>
    </div>
</div>

    

   <script>
   function deleteItem(cartItemId) {
       // Gửi yêu cầu xóa sản phẩm
       if (confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) {
           window.location.href = '/cart/delete?cartItemId=' + cartItemId;
       }
   }

    $(document).ready(function() {
        // Lắng nghe sự kiện thay đổi của checkbox
        $('.product-checkbox').change(function() {
            var selectedItems = [];

            // Lấy tất cả các checkbox đã được chọn
            $('.product-checkbox:checked').each(function() {
                selectedItems.push($(this).val());  // Lấy id của sản phẩm
            });

         // Kiểm tra xem có sản phẩm nào được chọn không
            if (selectedItems.length === 0) {
                // Nếu không có sản phẩm nào được chọn, gửi một mảng rỗng và cập nhật tổng tiền về 0
                $('#total-price').text('0 VND');
                selectedItems = [];
            }

            // Gửi AJAX request tới controller
            $.ajax({
                url: '/cart/update',  // URL của controller
                type: 'POST',
                data: {
                    selectedItems: selectedItems  // Gửi danh sách id sản phẩm được chọn
                },
                success: function(response) {
                    // Cập nhật tổng tiền từ response của server
                    $('#total-price').text(response.totalPrice + ' VND');
                },
                
            });
            
        });
    });
    $(document).ready(function() {
        // Lắng nghe sự kiện khi người dùng nhấn nút "Đặt hàng"
        $('#buyButton').click(function() {
            var selectedItems = [];

         // Lấy tất cả các checkbox đã được chọn
            $('.product-checkbox:checked').each(function() {
                selectedItems.push($(this).val());  // Lấy id của sản phẩm
            });

            // Kiểm tra nếu không có sản phẩm nào được chọn
            if (selectedItems.length === 0) {
                alert('Vui lòng chọn sản phẩm trước khi đặt hàng!');
                return;
            }

            // Gửi AJAX request tới server
            $.ajax({
                url: '/order/create',  // URL của controller
                type: 'POST',
                data: {
                    selectedItems: selectedItems  // Gửi danh sách id sản phẩm được chọn
                },
                success: function(orderId) {
                	const queryString = selectedItems.map(item => `selectedItems=${item}`).join('&');
                    // Chuyển hướng đến trang hiển thị thông tin đơn hàng với query parameters
                    window.location.href = `/order/summary/${orderId}?${queryString}`;
                },
                error: function() {
                    alert('Có lỗi xảy ra khi đặt hàng.');
                }
            });
        });
    });
</script>


</body>
</html>
