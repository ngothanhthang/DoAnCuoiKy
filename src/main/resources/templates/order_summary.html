<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin Đơn hàng</title>
    <!-- Thêm Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Thông tin đơn hàng</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Ảnh sản phẩm</th>
                    <th>Tên sản phẩm</th>
                    <th>Giá</th>
                    <th>Số lượng</th>
                    <th>Tổng tiền</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${order.orderItems}">
                    <td>
                        <img th:src="@{${item.product.imageUrl}}" alt="product image" style="width: 100px;">
                    </td>
                    <td th:text="${item.product.name}">Tên sản phẩm</td>
                    <td th:text="${item.price}">Giá</td>
                    <td th:text="${item.quantity}">Số lượng</td>
                    <td th:text="${item.price * item.quantity}">Tổng tiền</td>
                </tr>
            </tbody>
        </table>

        <h3>Tổng tiền: <span th:text="${order.totalAmount}">0</span> VND</h3>

        <h3>Địa chỉ giao hàng</h3>
        <div th:if="${defaultAddress != null}">
            <p>Địa chỉ hiện tại: <span th:text="${defaultAddress.streetAddress} + ', ' + ${defaultAddress.city} + ', ' + ${defaultAddress.state} + ', ' + ${defaultAddress.postalCode} + ', ' + ${defaultAddress.country}"></span></p>
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addressModal" th:data-address-id="${defaultAddress.id}" th:data-address-street="${defaultAddress.streetAddress}" th:data-address-city="${defaultAddress.city}" th:data-address-state="${defaultAddress.state}" th:data-address-postal="${defaultAddress.postalCode}" th:data-address-country="${defaultAddress.country}">
                Cập nhật địa chỉ
            </button>
        </div>
        <div th:if="${defaultAddress == null}">
            <p>Chưa có địa chỉ giao hàng. Bạn có thể thêm một địa chỉ mới.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addressModal">
                Thêm địa chỉ mới
            </button>
        </div>
		<!-- Modal hiển thị danh sách địa chỉ -->
				<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressListModalLabel" aria-hidden="true">
				    <div class="modal-dialog modal-lg">
				        <div class="modal-content">
				            <div class="modal-header">
				                <h5 class="modal-title" id="addressListModalLabel">Danh sách địa chỉ</h5>
				                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				            </div>
				            <div class="modal-body">
				                <div id="addressList">
				                    <!-- Lặp qua danh sách địa chỉ -->
				                    <div th:each="address : ${allAddresses}" class="address-card mb-3">
				                        <div class="card">
				                            <div class="card-body d-flex justify-content-between">
				                                <div>
				                                    <h6 class="card-title" th:text="${address.streetAddress} + ', ' + ${address.city} + ', ' + ${address.state} + ', ' + ${address.postalCode} + ', ' + ${address.country}"></h6>
				                                </div>
				                                <div>
				                                    <!-- Nút cập nhật địa chỉ -->
				                                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editAddressModal"
				                                            th:data-address-id="${address.id}"
				                                            th:data-address-street="${address.streetAddress}"
				                                            th:data-address-city="${address.city}"
				                                            th:data-address-state="${address.state}"
				                                            th:data-address-postal="${address.postalCode}"
				                                            th:data-address-country="${address.country}">
				                                        Cập nhật
				                                    </button>
				                                </div>
				                            </div>
				                        </div>
				                    </div>
				                </div>
				                <!-- Nút thêm địa chỉ mới -->
				                <button class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#editAddressModal" onclick="clearAddressForm()">
				                    Thêm địa chỉ mới
				                </button>
				            </div>
				        </div>
				    </div>
				</div>					
		<!-- Modal thêm hoặc cập nhật địa chỉ -->
			<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
			    <div class="modal-dialog">
			        <div class="modal-content">
			            <div class="modal-header">
			                <h5 class="modal-title" id="editAddressModalLabel">Thêm/Cập nhật địa chỉ</h5>
			                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			            </div>
			            <div class="modal-body">
			                <form th:action="@{/address/save}" method="post">
			                <input type="hidden" name="orderId" id="orderId" />
			                    <input type="hidden" name="id" id="addressId" />
			                    <div class="mb-3">
			                        <label for="streetAddress" class="form-label">Địa chỉ đường</label>
			                        <input type="text" class="form-control" id="streetAddress" name="streetAddress" required>
			                    </div>
			                    <div class="mb-3">
			                        <label for="city" class="form-label">Thành phố</label>
			                        <input type="text" class="form-control" id="city" name="city" required>
			                    </div>
			                    <div class="mb-3">
			                        <label for="state" class="form-label">Tình trạng</label>
			                        <input type="text" class="form-control" id="state" name="state" required>
			                    </div>
			                    <div class="mb-3">
			                        <label for="postalCode" class="form-label">Mã bưu điện</label>
			                        <input type="text" class="form-control" id="postalCode" name="postalCode" required>
			                    </div>
			                    <div class="mb-3">
			                        <label for="country" class="form-label">Quốc gia</label>
			                        <input type="text" class="form-control" id="country" name="country" required>
			                    </div>
			                    </div>
					                        <input type="hidden" name="isDefault" value="false" id="isDefaultHidden" />
					                        <div class="form-group">
					                            <div class="form-check">
					                                <input type="checkbox" class="form-check-input" id="isDefault" name="isDefault" value="true">
					                                <label class="form-check-label" for="isDefault">Đặt làm địa chỉ mặc định</label>
					                            </div>
					                        </div>
			                    <button type="submit" class="btn btn-primary mt-3">Lưu địa chỉ</button>
			                
			            </div>
			        </div>
			    </div>
			</div>	
			<!-- Liên kết tới trang cập nhật trạng thái đơn hàng -->
			<a th:href="@{/order/purchases(orderId=${orderId},selectedItem=${selectedItem})}" class="btn btn-success mt-3">Đặt hàng</a>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
		<script>
    // Lấy orderId từ URL
    var url = window.location.href;
    var segments = url.split('/');
    var orderId = segments.find(function(segment) {
        return !isNaN(segment) && segment !== '' && segment !== 'summary';
    });
 // Gán giá trị orderId vào ô input
    document.getElementById("orderId").value = orderId || '';
 // Xử lý sự kiện nhấn "Cập nhật địa chỉ"
    document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#editAddressModal"]').forEach(function(button) {
        button.addEventListener('click', function() {
            const addressId = button.getAttribute('data-address-id');
            const street = button.getAttribute('data-address-street');
            const city = button.getAttribute('data-address-city');
            const state = button.getAttribute('data-address-state');
            const postal = button.getAttribute('data-address-postal');
            const country = button.getAttribute('data-address-country');

            // Điền thông tin vào form
            document.getElementById('addressId').value = addressId;
            document.getElementById('streetAddress').value = street;
            document.getElementById('city').value = city;
            document.getElementById('state').value = state;
            document.getElementById('postalCode').value = postal;
            document.getElementById('country').value = country;

            // Cập nhật tiêu đề modal
            document.getElementById('editAddressModalLabel').textContent = "Cập nhật địa chỉ";
        });
    });

    // Xử lý sự kiện nhấn "Thêm địa chỉ mới"
    function clearAddressForm() {
        document.getElementById('addressId').value = '';
        document.getElementById('streetAddress').value = '';
        document.getElementById('city').value = '';
        document.getElementById('state').value = '';
        document.getElementById('postalCode').value = '';
        document.getElementById('country').value = '';
        document.getElementById('isDefault').checked = false;

        // Cập nhật tiêu đề modal
        document.getElementById('editAddressModalLabel').textContent = "Thêm địa chỉ mới";
    }

    // Lắng nghe sự kiện thay đổi trạng thái của checkbox
    document.getElementById('isDefault').addEventListener('change', function() {
        var isDefaultHidden = document.getElementById('isDefaultHidden');
        isDefaultHidden.value = this.checked ? 'true' : 'false';
    });
</script>
</body>
</html>
